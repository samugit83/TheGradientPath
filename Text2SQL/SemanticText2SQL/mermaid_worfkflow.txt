flowchart TD
    A["ğŸŒ USER QUESTION<br>Natural Language - Any Language"] --> B["ğŸ§  STEP 1: SQL GENERATION<br>LLM with Specialized Prompt"]
    B --> B1["ğŸ“Š Analyze User Intent"]
    B1 --> B2{"ğŸ” Strategy Decision"}
    B2 -- Exact Data --> C1["ğŸ“ˆ SQL FILTERS<br>WHERE price &gt; 20<br>WHERE date = 2020<br>WHERE category = Sci-Fi<br>Numeric/Date comparisons<br>Boolean logic"]
    B2 -- Text with Typos --> C2["ğŸ”¤ FUZZY MATCHING<br>levenshtein function<br>LOWER normalization<br>Typo tolerance 1-3 chars<br>Similarity ranking"]
    B2 -- Concepts/Themes --> C3["ğŸ¯ VECTOR EMBEDDINGS<br>Semantic understanding<br>Meaning-based search<br>Cross-language support<br>Conceptual similarity"]
    B2 -- Complex Query --> C4["ğŸ”„ COMBINED APPROACH<br>SQL + Fuzzy + Embeddings<br>Multiple strategies<br>Optimized performance<br>Comprehensive results"]
    C1 --> D["ğŸ“ Generate SQL Query<br>with placeholders"]
    C2 --> D
    C3 --> D
    C4 --> D
    D --> E{"ğŸ¤” Need Embeddings?"}
    E -- Yes --> F["ğŸ”® STEP 3: EMBEDDING GENERATION<br>OpenAI text-embedding-3-small"]
    E -- No --> G["ğŸ›¡ï¸ STEP 2: VALIDATION<br>sqlglot Security Checks"]
    F --> F1["ğŸ“¤ Extract Search Terms<br>from embedding_params"]
    F1 --> F2["ğŸŒ Call OpenAI API<br>1536-dimensional vectors"]
    F2 --> F3["ğŸ”„ Format for PostgreSQL<br>vector format"]
    F3 --> F4["ğŸ”— Substitute Placeholders<br>vector placeholders"]
    F4 --> G
    G --> G1["ğŸ”’ Security Validation"]
    G1 --> G2["âœ“ Only SELECT queries<br>âœ“ No write operations<br>âœ“ No SQL injection<br>âœ“ No dangerous keywords"]
    G2 --> G3["ğŸ“ Structural Validation"]
    G3 --> G4["âœ“ Parseable SQL syntax<br>âœ“ No vector columns in GROUP BY<br>âœ“ Proper aggregate usage"]
    G4 --> H{"âœ… Validation Result"}
    H -- PASS --> I["ğŸ—„ï¸ STEP 4: QUERY EXECUTION<br>PostgreSQL Database"]
    H -- FAIL --> J{"ğŸš¨ Error Type"}
    J -- Security Issue --> K["âŒ ABORT<br>No retry allowed"]
    J -- Fixable Error --> L["ğŸ”„ RETRY MECHANISM<br>Feed error back to LLM"]
    L --> M["ğŸ“š Error History Analysis<br>Previous attempts<br>Error messages<br>Context preservation"]
    M --> N["ğŸ”„ Regenerate SQL<br>with comprehensive feedback"]
    N --> O{"ğŸ”„ Retry Count"}
    O -- &lt; 4 attempts --> B
    O -- "&gt;= 4 attempts" --> P["âŒ MAX RETRIES EXCEEDED<br>Return failure with history"]
    I --> I1["ğŸ”Œ Connect to Database<br>psycopg2 connection"]
    I1 --> I2["âš™ï¸ Parameter Substitution<br>Manual replacement for complex queries"]
    I2 --> I3["â–¶ï¸ Execute Query<br>cursor.execute"]
    I3 --> I4{"ğŸ“Š Execution Result"}
    I4 -- SUCCESS --> Q["ğŸ“‹ Fetch Results<br>Rows as dictionaries<br>Column metadata<br>Row count"]
    I4 -- FAIL --> R["ğŸ“ Capture Error Details<br>PostgreSQL error message<br>Query context<br>Parameter info"]
    R --> S["ğŸ”„ Add to Attempt History<br>for retry mechanism"]
    S --> L
    Q --> T["ğŸ¤– STEP 5: ANSWER GENERATION<br>LLM Natural Language Response"]
    T --> T1["ğŸ“ Format Results<br>Skip embedding columns<br>Limit to 20 rows<br>Human-readable format"]
    T1 --> T2["ğŸ§  Generate Answer<br>Original question context<br>Query results analysis<br>Natural language response"]
    T2 --> U["ğŸ’¬ FINAL ANSWER<br>Natural Language Response"]
    P --> V["âŒ ERROR RESPONSE<br>with detailed failure info"]

    style A fill:#e1f5fe
    style B fill:#f3e5f5
    style C1 fill:#e8f5e8
    style C2 fill:#fff3e0
    style C3 fill:#fce4ec
    style C4 fill:#f1f8e9
    style F fill:#e3f2fd
    style G fill:#fff8e1
    style I fill:#e8f5e8
    style K fill:#ffebee
    style P fill:#ffebee
    style T fill:#f3e5f5
    style U fill:#e1f5fe
    style V fill:#ffebee
